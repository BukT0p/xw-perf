<!doctype html>
<!--
Copyright 2013 The Polymer Authors. All rights reserved.
Copyright 2014 Intel Corporation. All rights reserved.

License: BSD-3-clause-Google and BSD-3-clause-Intel, see LICENSE.txt
-->
<html>
  <head>
    <meta charset="utf-8" />
    <title>Contacts</title>

    <meta name="viewport" content="width=device-width, user-scalable=yes, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json" />

    <link rel="import" href="bower_components/core-animated-pages/core-animated-pages.html" />
    <link rel="import" href="bower_components/core-animated-pages/transitions/cross-fade.html" />
    <link rel="import" href="bower_components/core-animated-pages/transitions/slide-from-right.html" />
    <link rel="import" href="bower_components/core-drawer-panel/core-drawer-panel.html" />
    <link rel="import" href="bower_components/core-header-panel/core-header-panel.html" />
    <link rel="import" href="bower_components/core-icons/core-icons.html" />
    <link rel="import" href="bower_components/core-icons/social-icons.html" />
    <link rel="import" href="bower_components/core-item/core-item.html" />
    <link rel="import" href="bower_components/core-list/core-list.html" />
    <link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
    <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html" />
    <link rel="import" href="bower_components/paper-item/paper-item.html" />
    <link rel="import" href="bower_components/paper-tabs/paper-tabs.html" />

    <link rel="import" href="bower_components/my-utils/my-perf-box.html" />

    <link rel="import" href="contacts-card.html" />
    <link rel="import" href="contacts-datagen.html" />
    <link rel="import" href="contacts-item.html" />
    <link rel="stylesheet" href="app.css" />
  </head>
  <body class="polymer-ui-body-text" fullbleed layout vertical>
    <polymer-element name="my-app">
      <template>
        <style type="text/css">
          /*
          * {
            outline: 1px dotted #f0f;
          }
          */
          #sideMenuButton {
            visibility: hidden;
          }
          [narrow] #sideMenuButton {
            visibility: visible;
          }
          #my-toolbar {
            padding: 0px;
          }
          #my-toolbar-top {
            height: 100%;
            width: 100%;
            padding: 0 16px;
          }
          #my-toolbar, #my-toolbar::shadow #topBar {
            background-color: #388e3c;
            color: white;
          }
          #my-tab-box paper-tab::shadow #ink {
            color: #2196f3;
          }
          #my-tab-box paper-tabs::shadow #selectionBar {
            background-color: #2196f3;
          }
          #my-drawer {
            background-color: #c8e6c9;
          }
          #my-drawer {
            padding: 0 0.5em;
          }
        </style>

        <contacts-datagen id="data">
        </contacts-datagen>

        <core-drawer-panel id="my-drawer-panel">
          <div drawer id="my-drawer">
            <core-item>
              Options
            </core-item>
            <core-item>
              Settings
            </core-item>
            <core-item>
              Preferences
            </core-item>
            <core-item>
              Misc
            </core-item>
            <core-item>
              Other
            </core-item>
          </div>

          <core-animated-pages main id="listOrCard" selected="0"
              transitions="cross-fade">
            <section layout vertical>
              <core-header-panel mode="waterfall-tall" tallClass="medium-tall"
                  id="my-header-panel" flex cross-fade>
                <core-toolbar id="my-toolbar">
                  <paper-icon-button icon="menu" on-tap="{{ toggleMenu }}"
                      id="sideMenuButton">
                  </paper-icon-button>
                  <div flex>Contacts</div>
                  <paper-icon-button icon="search"></paper-icon-button>
                  <paper-icon-button icon="more-vert"></paper-icon-button>

                  <paper-tabs class="bottom fit" selected="0" flex id="my-tabs">
                    <paper-tab>
                      <paper-icon-button icon="favorite">
                      </paper-icon-button>
                      Favorites
                    </paper-tab>
                    <paper-tab>
                      <paper-icon-button icon="social:person">
                      </paper-icon-button>
                      All
                    </paper-tab>
                    <paper-tab>
                      <paper-icon-button icon="social:group">
                      </paper-icon-button>
                      Groups
                    </paper-tab>
                  </paper-tabs>
                </core-toolbar>

                <core-animated-pages transitions="slide-from-right" id="my-pages"
                  selected="0" layout>

                  <section layout>
                    <core-list data="{{favorites}}" id="favoritesList"
                        height="80" on-core-activate="{{itemActivated}}">
                      <template>
                        <contacts-item model="{{model}}">
                        </contacts-item>
                      </template>
                    </core-list>
                  </section>

                  <section layout>
                    <core-list data="{{data}}" id="allList"
                        height="80" on-core-activate="{{itemActivated}}">
                      <template>
                        <contacts-item model="{{model}}" favicon>
                        </contacts-item>
                      </template>
                    </core-list>
                  </section>

                  <section layout>
                    <div style="margin: 1em">groups are not yet implemented</div>
                  </section>
                </core-animated-pages>
              </core-header-panel>
            </section>

            <section layout vertical>
              <contacts-card id="card" on-done="{{cardDone}}" cross-fade>
              </contacts-card>
            </section>
          </core-animated-pages>
        </core-drawer-panel>
      </template>
      <script>
        (function() {
          'use strict';

          function passThroughDatabase(data, cb) {
            var db = null;
            var loadedData = [];

            function onerror(err) {
              console.log('DB error: ' + err);
            };

            var req = indexedDB.open('contacts', 1);
            req.onupgradeneeded = function(e) {
              db = e.target.result;
              e.target.transaction.onerror = onerror;
              try {
                db.deleteObjectStore('contacts');
              } catch (e) {
              }
              var store = db.createObjectStore('contacts', {
                autoIncrement: true,
              });
            };

            req.onsuccess = function(e) {
              db = e.target.result;
              var txn = db.transaction(['contacts'], 'readwrite');
              var store = txn.objectStore('contacts');
              store.clear();
              for (var i = 0; i < data.length; i++) {
                store.put(data[i]);
              }
              txn.onerror = onerror;
              txn.oncomplete = function(e) {
                var txn = db.transaction(['contacts']);
                var store = txn.objectStore('contacts');
                var readReq = store.openCursor();
                readReq.onsuccess = function(e) {
                  var cursor = event.target.result;
                  if (cursor) {
                    loadedData.push(cursor.value);
                    cursor.continue();
                  }
                  else {
                    var favorites = [];
                    for (var i = 0; i < loadedData.length; i++) {
                      if (loadedData[i].favorite) {
                        favorites.push(loadedData[i]);
                      }
                    }
                    cb(data, favorites);
                  }
                };
                readReq.onerror = onerror;
              };
            };
            req.onerror = onerror;
          }

          Polymer({
            toggleMenu: function() {
              this.$['my-drawer-panel'].togglePanel();
            },
            data: [],
            favorites: [],
            ready: function() {
              var data = this.$.data.data;

              // Ideally we'd make the core-list be directly backed by the
              // database rather than copying, but core-list wants to know
              // the item count, and perform bidirection mapping between
              // dense 0-based index and raw data.
              // TODO: future work: fork core-list as my-db-list?
              var timeBefore = +(new Date());
              passThroughDatabase(data, (function (data, favorites) {
                var dt = +(new Date()) - timeBefore;
                console.log('serialized and parsed ' + data.length + ' IndexedDB records in ' + dt + ' ms');

                this.data = data;
                this.favorites = favorites;
                this.$.allList.refresh();
                this.$.favoritesList.refresh();
              }).bind(this));

              this.$.favoritesList.scrollTarget = this.$['my-header-panel'];
              this.$.allList.scrollTarget = this.$['my-header-panel'];

              var myTabs = this.$['my-tabs'];
              var myPages = this.$['my-pages'];
              myTabs.addEventListener('core-select', function() {
                myPages.selected = myTabs.selected;
              });
            },
            itemActivated: function(e) {
              this.$.card.model = e.detail.item.model;
              this.$.listOrCard.selected = 1;
            },
            cardDone: function(e) {
              this.$.listOrCard.selected = 0;
            },
          });
        })();
      </script>
    </polymer-element>
    <my-app flex relative>
    </my-app>
    <my-perf-box>
    </my-perf-box>
  </body>
</html>
<!-- vim:set sw=2 sts=2 et: -->
