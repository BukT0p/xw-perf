<!doctype html>
<!--
Copyright 2013 The Polymer Authors. All rights reserved.
Copyright 2014 Intel Corporation

Use of this source code is governed by a BSD-style
license that can be found in the LICENSE.txt file.
-->
<html>
  <head>
    <title>app-widgets</title>
    <meta charset="utf-8" />
    <script src="bower_components/platform/platform.js"></script>
    <meta name="viewport" content="width=device-width, user-scalable=yes, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="import" href="app-widgets.html" />
    <link rel="import" href="bower_components/font-roboto/roboto.html" />
    <link rel="import" href="bower_components/core-animated-pages/core-animated-pages.html" />
    <link rel="import" href="bower_components/core-animated-pages/transitions/slide-from-right.html" />
    <link rel="import" href="bower_components/core-drawer-panel/core-drawer-panel.html" />
    <link rel="import" href="bower_components/core-header-panel/core-header-panel.html" />
    <link rel="import" href="bower_components/core-icons/core-icons.html" />
    <link rel="import" href="bower_components/core-item/core-item.html" />
    <link rel="import" href="bower_components/core-list/core-list.html" />
    <link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
    <link rel="import" href="bower_components/paper-checkbox/paper-checkbox.html" />
    <link rel="import" href="bower_components/paper-button/paper-button.html" />
    <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html" />
    <link rel="import" href="bower_components/paper-item/paper-item.html" />
    <link rel="import" href="bower_components/paper-tabs/paper-tabs.html" />
    <link rel="import" href="item.html" />
    <link rel="import" href="feed.html" />
    <link rel="import" href="my-settings-tab.html" />
    <link rel="stylesheet" href="app.css" />
  </head>
  <body class="polymer-ui-body-text" fullbleed layout vertical>
    <polymer-element name="my-app">
      <template>
        <style type="text/css">
          /*
          * {
            outline: 1px dotted #f0f;
          }
          */
          #my-toolbar {
            padding: 0px;
          }
          #my-toolbar-top {
            height: 100%;
            width: 100%;
            padding: 0 8px;
          }
          #my-toolbar, #my-toolbar-top, #my-tab-box {
            background-color: #607d8b;
            color: white;
          }
          #my-tab-box paper-tab #ink {
            color: #ffcc80;
          }
          #my-tab-box #selectionBar {
            background-color: #ffcc80;
          }
          #my-drawer {
            background-color: #cfd8dc;
          }
          #my-drawer {
            padding: 0 0.5em;
          }
        </style>
        <my-feed id="myFeed">
        </my-feed>
        <core-drawer-panel id="my-drawer-panel">
          <div drawer id="my-drawer">
            <core-item>
              Options
            </core-item>
            <core-item>
              Settings
            </core-item>
            <core-item>
              Preferences
            </core-item>
            <core-item>
              Misc
            </core-item>
            <core-item>
              Other
            </core-item>
          </div>
          <div main id="my-main" layout vertical>
            <core-header-panel mode="waterfall-tall" tallClass="medium-tall"
                id="my-header-panel" flex>
              <core-toolbar id="my-toolbar" vertical>
                <div horizontal layout id="my-toolbar-top" flex class="fit"
                    center>
                  <paper-icon-button icon="menu" on-tap="{{ toggleMenu }}"></paper-icon-button>
                  <div flex>Sociable - permanent beta</div>
                  <paper-icon-button icon="search"></paper-icon-button>
                  <paper-icon-button icon="more-vert"></paper-icon-button>
                </div>

                <div class="bottom fit" horizontal layout id="my-tab-box">
                  <paper-tabs selected="0" flex id="my-tabs">
                    <paper-tab>RECENT</paper-tab>
                    <paper-tab>COMPOSE</paper-tab>
                    <paper-tab>SETTINGS</paper-tab>
                  </paper-tabs>
                </div>
              </core-toolbar>

              <core-animated-pages transitions="slide-from-right" id="my-pages"
                selected="0">

                <section layout flex id="my-list-section">
                  <core-list data="{{data}}" height="80" id="my-list" flex>
                    <template>
                      <my-item model="{{ model }}">
                      </my-item>
                    </template>
                  </core-list>
                </section>

                <section>
                  your ad here
                </section>

                <my-settings-tab></my-settings-tab>
              </core-animated-pages>
            </core-header-panel>
          </div>
        </core-drawer-panel>
      </template>
      <script>
        Polymer({
          toggleMenu: function() {
            this.$['my-drawer-panel'].togglePanel();
          },
          ready: function() {
            var myTabs = this.$['my-tabs'];
            var myPages = this.$['my-pages'];
            var myList = this.$['my-list'];
            myList.scrollTarget = this.$['my-header-panel'];
            myTabs.addEventListener('core-select', function() {
              myPages.selected = myTabs.selected;
            });
            this.data = this.$.myFeed.data;
          },
        });
      </script>
    </polymer-element>
    <my-app flex relative>
    </my-app>
    <div style="height: 64px; background: grey;">
      <input type="checkbox" id="perf-enabled" style="float: left;"></input>
      <div id="perf-fps"></div>
      <div id="perf-timings"></div>
    </div>
    <script>
      (function(exports){
        'use strict';
        // big enough for just over a minute at 60fps
        var ringBuffer = new Float64Array(4096);
        var frameIndex = 0;
        var statsShowing = 0;

        var MAX_BUCKET = 30;
        var FPS_PER_BUCKET = 1;
        var MS_PER_BUCKET = 1;

        document.getElementById('perf-enabled').addEventListener('change', function () {

          statsShowing = document.getElementById('perf-enabled').checked;
          if (!statsShowing) {
            document.getElementById('perf-fps').innerText = '';
            document.getElementById('perf-timings').innerText = '';
          }
        });

        function frame(now) {
          ringBuffer[frameIndex] = now;

          // approx. every second at 60fps, dump out stats
          // (keep this a divisor of ringBuffer.length because we make
          // frameIndex wrap around)
          if (statsShowing && (frameIndex % 64) == 0) {
            var t = -1;
            var fpsBuckets = {};
            var timeBuckets = {};

            for (var i = 1; i <= ringBuffer.length; i++) {
              var nt = ringBuffer[(frameIndex + i) % ringBuffer.length];

              if (t < 0) {
                t = nt;
                continue;
              }

              if (nt == 0) {
                // skip unfilled portion of ring buffer: wrap around
                // so that frameIndex + i = ringBufferLength ≡ 0 (mod length)
                i = ringBuffer.length - frameIndex;
                continue;
              }

              var dt = nt - t;
              t = nt;

              var roundedTime = Math.round(dt / MS_PER_BUCKET) * MS_PER_BUCKET;
              if (!timeBuckets[roundedTime])
                timeBuckets[roundedTime] = 0;
              timeBuckets[roundedTime] += 1;

              // don't divide by zero
              if (dt == 0)
                dt = 0.001;

              var roundedFps = Math.floor(1000 / (FPS_PER_BUCKET * dt)) * FPS_PER_BUCKET;
              if (!fpsBuckets[roundedFps])
                fpsBuckets[roundedFps] = 0;
              fpsBuckets[roundedFps] += 1;
            }

            var s = 'fps:';
            for (var i in fpsBuckets) {
              s += ' ' + fpsBuckets[i] + '×' + i + 'fps;';
            }
            document.getElementById('perf-fps').innerText = s;
            s = 'times:';
            for (var i in timeBuckets) {
              s += ' ' + timeBuckets[i] + '×' + i + 'ms;';
            }
            document.getElementById('perf-timings').innerText = s;
          }

          requestAnimationFrame(frame);
          frameIndex = (frameIndex + 1) % ringBuffer.length;
        }

        requestAnimationFrame(frame);
      })(window);
    </script>
  </body>
</html>
<!-- vim:set sw=2 sts=2 et: -->
